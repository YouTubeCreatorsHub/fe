name: Project Board Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed]

jobs:
  project_automation:
    runs-on: ubuntu-latest
    env:
      FORCE_JAVASCRIPT_ACTIONS_TO_NODE20: true
    permissions:
      issues: write
      pull-requests: write
      organization-projects: write
      repository-projects: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.AUTO_ACTIONS }}
          script: |
            const projectQuery = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            try {
              const projectResult = await github.graphql(projectQuery, {
                org: "YouTubeCreatorsHub",
                number: 1
              });

              if (!projectResult.organization?.projectV2) {
                throw new Error('Project not found');
              }

              const projectId = projectResult.organization.projectV2.id;
              const statusField = projectResult.organization.projectV2.fields.nodes.find(
                field => field.name === "Status"
              );

              if (!statusField) {
                throw new Error('Status field not found');
              }

              const addMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `;

              let contentId;
              let statusOptionId;

              if (context.eventName === 'issues') {
                contentId = context.payload.issue.node_id;
                statusOptionId = context.payload.action === 'closed' 
                  ? statusField.options.find(o => o.name === 'Done')?.id
                  : statusField.options.find(o => o.name === 'Backlog')?.id;
              } else if (context.eventName === 'pull_request') {
                contentId = context.payload.pull_request.node_id;
                statusOptionId = context.payload.action === 'closed' 
                  ? statusField.options.find(o => o.name === 'Done')?.id
                  : statusField.options.find(o => o.name === 'In Review')?.id;
              }

              if (!statusOptionId) {
                throw new Error('Status option not found');
              }

              try {
                const addResult = await github.graphql(addMutation, {
                  projectId,
                  contentId
                });

                if (addResult.addProjectV2ItemById?.item?.id) {
                  const updateMutation = `
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: { singleSelectOptionId: $optionId }
                      }) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `;

                  await github.graphql(updateMutation, {
                    projectId,
                    itemId: addResult.addProjectV2ItemById.item.id,
                    fieldId: statusField.id,
                    optionId: statusOptionId
                  });
                }
              } catch (error) {
                if (!error.message.includes('Project item already exists')) {
                  throw error;
                }
              }

            } catch (error) {
              console.error('Error:', error.message);
              core.setFailed(error.message);
            }

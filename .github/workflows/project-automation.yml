name: Project Board Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, reopened, closed]

jobs:
  project_automation:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      organization-projects: write
      repository-projects: write
      contents: read
    steps:
      - uses: monry/actions-get-project-id@v2
        id: get-project-id
        with:
          github-token: ${{ secrets.AUTO_ACTIONS }}
          project-owner: 'YouTubeCreatorsHub'
          project-number: 1

      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.AUTO_ACTIONS }}
          script: |
            const PROJECT = {
              ID: '${{ steps.get-project-id.outputs.project-id }}',
              COLUMNS: {
                BACKLOG: '17052d30',        // ğŸ“‹ ì•„ì§ ìŠ¤í”„ë¦°íŠ¸ì— í• ë‹¹ë˜ì§€ ì•Šì€ ì „ì²´ ì‘ì—…
                SPRINT_BACKLOG: '2b4b3335',  // ğŸ“… í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ì—ì„œ ì§„í–‰í•  ì‘ì—…ë“¤
                IN_PROGRESS: 'dc54b4f8',     // ğŸ’» í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‘ì—…
                IN_REVIEW: '3fdc4773',       // ğŸ‘€ PR ìƒì„±ë˜ì–´ ì½”ë“œ ë¦¬ë·° ì¤‘ì¸ ì‘ì—…
                DONE: '98236657'            // âœ… ì™„ë£Œë˜ê³  ë°°í¬ëœ ì‘ì—…
              }
            };
            
            // ì´ìŠˆë‚˜ PRì„ íŠ¹ì • ì»¬ëŸ¼ìœ¼ë¡œ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
            async function moveIssueToColumn(itemId, columnId) {
              const mutation = `
                mutation {
                  updateProjectV2ItemFieldValue(
                    input: {
                      projectId: "${PROJECT.ID}"
                      itemId: "${itemId}"
                      fieldId: "Status"
                      value: { 
                        singleSelectOptionId: "${columnId}"
                      }
                    }
                  ) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;
              
              try {
                await github.graphql(mutation);
              } catch (error) {
                console.error('Error moving item:', error);
                // ì•„ì´í…œì´ ì•„ì§ í”„ë¡œì íŠ¸ì— ì—†ëŠ” ê²½ìš°, ë¨¼ì € ì¶”ê°€
                if (error.message.includes('Could not resolve to a ProjectV2Item')) {
                  const addMutation = `
                    mutation {
                      addProjectV2ItemById(input: {
                        projectId: "${PROJECT.ID}"
                        contentId: "${itemId}"
                      }) {
                        item {
                          id
                        }
                      }
                    }
                  `;
                  await github.graphql(addMutation);
                  // ë‹¤ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œë„
                  await github.graphql(mutation);
                } else {
                  throw error;
                }
              }
            }
            
            // ì´ìŠˆ ìë™í™”
            if (context.eventName === 'issues') {
              const repo = context.payload.repository.name.toLowerCase();
              
              if (context.payload.action === 'opened') {
                // FE ë ˆí¬ì§€í† ë¦¬ì˜ ì´ìŠˆëŠ” Backlogë¡œ ì´ë™
                if (repo === 'fe') {
                  await moveIssueToColumn(context.payload.issue.node_id, PROJECT.COLUMNS.BACKLOG);
                }
                // BE ë ˆí¬ì§€í† ë¦¬ì˜ ì´ìŠˆëŠ” Sprint Backlogë¡œ ì´ë™
                else if (repo === 'be') {
                  await moveIssueToColumn(context.payload.issue.node_id, PROJECT.COLUMNS.SPRINT_BACKLOG);
                }
              }
              
              // ì´ìŠˆê°€ ë‹«íˆë©´ Doneìœ¼ë¡œ ì´ë™
              else if (context.payload.action === 'closed') {
                await moveIssueToColumn(context.payload.issue.node_id, PROJECT.COLUMNS.DONE);
              }
            }
            
            // PR ìë™í™”
            if (context.eventName === 'pull_request') {
              if (context.payload.action === 'opened') {
                // PRì´ ì—´ë¦¬ë©´ In Reviewë¡œ ì´ë™
                await moveIssueToColumn(context.payload.pull_request.node_id, PROJECT.COLUMNS.IN_REVIEW);
              }
              else if (context.payload.action === 'closed' && context.payload.pull_request.merged) {
                // PRì´ ë¨¸ì§€ë˜ë©´ Doneìœ¼ë¡œ ì´ë™
                await moveIssueToColumn(context.payload.pull_request.node_id, PROJECT.COLUMNS.DONE);
              }
            }

name: Project Board Automation

on:
  issues:
    types: [opened, reopened, closed]    # ì´ìŠˆê°€ ì—´ë¦¬ê±°ë‚˜, ë‹¤ì‹œ ì—´ë¦¬ê±°ë‚˜, ë‹«í ë•Œ
  pull_request:
    types: [opened, reopened, closed]    # PRì´ ì—´ë¦¬ê±°ë‚˜, ë‹¤ì‹œ ì—´ë¦¬ê±°ë‚˜, ë‹«í ë•Œ

jobs:
  project_automation:
    runs-on: ubuntu-latest
    permissions:  # GitHub Token ê¶Œí•œ ì„¤ì •
      issues: write
      pull-requests: write
      projects: write
      contents: write
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const PROJECT = {
              ID: 'PVT_kwDOC0FCP84AsibV',  // ì‹¤ì œ í”„ë¡œì íŠ¸ ID
              STATUS_FIELD: 'PVTSSF_lADOC0FCP84Asip6zgjctNk',  // Status í•„ë“œ ID
              COLUMNS: {
                BACKLOG: 'd04ab34f',        // ğŸ“‹ Backlog
                TODO: 'f75ad846',           // âœ… Todo
                IN_PROGRESS: '47fc9ee4',     // ğŸ’» In Progress
                DONE: '98236657'            // âœ… Done
              }
            };

            // ì´ìŠˆë‚˜ PRì„ í”„ë¡œì íŠ¸ì˜ íŠ¹ì • ì»¬ëŸ¼ìœ¼ë¡œ ì´ë™ì‹œí‚¤ëŠ” í•¨ìˆ˜
            async function moveIssueToColumn(nodeId, columnId) {
              try {
                // í”„ë¡œì íŠ¸ì— ì´ìŠˆ/PR ì¶”ê°€
                const addToProjectMutation = `
                  mutation($projectId: ID!, $contentId: ID!) {
                    addProjectV2ItemById(input: {
                      projectId: $projectId
                      contentId: $contentId
                    }) {
                      item {
                        id
                      }
                    }
                  }
                `;

                const addResponse = await github.graphql(addToProjectMutation, {
                  projectId: PROJECT.ID,
                  contentId: nodeId
                });

                // ìƒíƒœ ì—…ë°ì´íŠ¸ (ì»¬ëŸ¼ ì´ë™)
                if (addResponse.addProjectV2ItemById.item) {
                  const itemId = addResponse.addProjectV2ItemById.item.id;
                  const updateStatusMutation = `
                    mutation($projectId: ID!, $itemId: ID!, $statusFieldId: ID!, $columnId: String!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $statusFieldId
                        value: { 
                          singleSelectOptionId: $columnId
                        }
                      }) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `;

                  await github.graphql(updateStatusMutation, {
                    projectId: PROJECT.ID,
                    itemId: itemId,
                    statusFieldId: PROJECT.STATUS_FIELD,
                    columnId: columnId
                  });
                }
              } catch (error) {
                console.error('Error:', error);
              }
            }

            // ì´ìŠˆ ìë™í™”
            if (context.eventName === 'issues') {
              const issueId = context.payload.issue.node_id;
              const repo = context.payload.repository.name.toLowerCase();
              
              if (context.payload.action === 'opened' || context.payload.action === 'reopened') {
                // FE ë ˆí¬ì§€í† ë¦¬ì˜ ì´ìŠˆëŠ” Backlogë¡œ
                if (repo === 'fe') {
                  await moveIssueToColumn(issueId, PROJECT.COLUMNS.BACKLOG);
                }
                // BE ë ˆí¬ì§€í† ë¦¬ì˜ ì´ìŠˆëŠ” Todoë¡œ
                else if (repo === 'be') {
                  await moveIssueToColumn(issueId, PROJECT.COLUMNS.TODO);
                }
              }
              else if (context.payload.action === 'closed') {
                await moveIssueToColumn(issueId, PROJECT.COLUMNS.DONE);
              }
            }

            // PR ìë™í™”
            if (context.eventName === 'pull_request') {
              const prId = context.payload.pull_request.node_id;
              
              if (context.payload.action === 'opened' || context.payload.action === 'reopened') {
                await moveIssueToColumn(prId, PROJECT.COLUMNS.IN_PROGRESS);
              }
              else if (context.payload.action === 'closed' && context.payload.pull_request.merged) {
                await moveIssueToColumn(prId, PROJECT.COLUMNS.DONE);
              }
            }

  add_reviewers:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    permissions:
      pull-requests: write
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['choco5958', 'lim3873', 'tlswltjq']  // ìë™ í• ë‹¹ë  ë¦¬ë·°ì–´ ëª©ë¡
              });
            } catch (error) {
              console.error('Error adding reviewers:', error);
            }
